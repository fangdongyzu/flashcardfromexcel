<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Flashcards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        html {
            touch-action: manipulation;
        }

        body {
            /* Font set to BiauKai (標楷體) */
            font-family: 'BiauKai', 'DFKai-SB', 'KaiTi', 'Inter', serif;
            background-color: #f3f4f6;
            -webkit-font-smoothing: antialiased;
            overscroll-behavior-y: none;
        }

        /* --- 3D Flip & Card Styles --- */
        .perspective-container {
            perspective: 1000px;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
            transform-style: preserve-3d;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .card-container.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1.5rem;
            background: white;
            padding: 2rem;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
        }

        .card-front {
            z-index: 2;
            transform: rotateY(0deg);
        }

        .card-back {
            transform: rotateY(180deg);
        }

        /* --- Scale Back Content --- */
        #card-back-content {
            transform: scale(0.75);
            transform-origin: center;
            width: 100%;
        }

        /* Setup Styles */
        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }

        .drop-zone:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .tab-btn {
            padding-bottom: 0.5rem;
            color: #94a3b8;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #3b82f6;
            border-color: #3b82f6;
        }

        .mode-btn.active {
            background-color: #1e293b;
            color: white;
            border-color: #1e293b;
        }

        /* Animations */
        @keyframes shuffleShake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-1deg); }
            75% { transform: translateX(5px) rotate(1deg); }
            100% { transform: translateX(0); }
        }

        .shaking {
            animation: shuffleShake 0.4s ease-in-out;
        }

        /* Quiz Button Styles */
        .option-btn {
            transition: all 0.2s;
            border: 2px solid #e2e8f0;
        }

        .option-btn:hover:not(:disabled) {
            border-color: #94a3b8;
            background-color: #f8fafc;
            transform: translateY(-2px);
        }

        .option-btn.correct {
            background-color: #dcfce7 !important;
            border-color: #22c55e !important;
            color: #15803d !important;
        }

        .option-btn.incorrect {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #b91c1c !important;
            opacity: 0.8;
        }

        /* Checkbox Style */
        .custom-checkbox:checked {
            background-color: #1e293b;
            border-color: #1e293b;
        }
    </style>
</head>

<body class="h-screen w-full flex flex-col items-center justify-center text-slate-800 p-4">

    <!-- SETUP SCREEN -->
    <div id="setup-screen" class="w-full max-w-lg bg-white p-8 rounded-3xl shadow-xl text-center">
        <div class="mb-4">
            <i class="fa-brands fa-github text-5xl text-slate-800 mb-4"></i>
            <h1 class="text-3xl font-bold mb-2">Flashcard Library</h1>
            <p id="repo-status" class="text-slate-500 text-sm">Connecting to GitHub...</p>
        </div>

        <div class="flex justify-center gap-8 mb-6 border-b border-slate-100">
            <button onclick="switchTab('github')" id="tab-github" class="tab-btn active">GitHub Library</button>
            <button onclick="switchTab('upload')" id="tab-upload" class="tab-btn">Upload File</button>
        </div>

        <div id="panel-github" class="space-y-4 animate-fade-in">
            <div class="text-left">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Select Folder</label>
                <select id="gh-folder-select"
                    class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-medium focus:outline-none focus:border-blue-500 text-slate-700">
                    <option value="" disabled selected>Loading folders...</option>
                </select>
            </div>

            <div class="text-left">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Select File</label>
                <select id="gh-file-select" disabled
                    class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-medium focus:outline-none focus:border-blue-500 text-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <option value="" disabled selected>-- First select a folder --</option>
                </select>
            </div>

            <button onclick="loadGitHubFile()" id="btn-gh-load" disabled
                class="w-full py-3 rounded-xl bg-slate-800 text-white font-bold shadow-lg hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                Load Deck
            </button>
        </div>

        <div id="panel-upload" class="hidden">
            <label
                class="drop-zone w-full h-40 flex flex-col items-center justify-center rounded-2xl cursor-pointer mb-6">
                <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i>
                <span class="text-slate-500 font-medium">Click to upload .xlsx or .csv</span>
                <input type="file" id="file-input" accept=".xlsx, .xls, .csv" class="hidden" />
            </label>
            <div class="text-xs text-left text-slate-400 bg-slate-50 p-4 rounded-xl">
                <p class="font-bold mb-1">Manual Mode:</p>
                <p>Use this tab if you want to upload a file from your computer instead of using the GitHub library.
                    Ensure CSV files are UTF-8 encoded.</p>
            </div>
        </div>
    </div>

    <!-- COLUMN SELECTION SCREEN -->
    <div id="column-selection-screen" class="hidden w-full max-w-lg bg-white p-8 rounded-3xl shadow-xl text-center">
        <div class="mb-6">
            <i class="fa-solid fa-list-check text-5xl text-slate-800 mb-4"></i>
            <h1 class="text-2xl font-bold mb-2">Select Columns</h1>
            <p class="text-slate-500 text-sm">Choose which text(s) to display on the back of the flashcard.</p>
        </div>
        
        <div class="text-left mb-6 max-h-60 overflow-y-auto pr-2" id="column-list">
            <!-- Checkboxes injected here -->
        </div>

        <button onclick="confirmColumnSelection()" 
            class="w-full py-3 rounded-xl bg-slate-800 text-white font-bold shadow-lg hover:bg-slate-700 transition">
            Start Learning
        </button>
    </div>

    <!-- APP SCREEN -->
    <div id="app-screen" class="hidden w-full max-w-2xl flex flex-col h-[95vh] py-2">
        <div class="flex flex-col md:flex-row items-center justify-between mb-3 px-2 gap-3">
            <div class="flex gap-4">
                <button onclick="resetApp()"
                    class="text-slate-400 hover:text-red-500 transition text-sm flex items-center"><i
                        class="fa-solid fa-arrow-left mr-1"></i> Exit</button>
                <button onclick="shuffleCards()"
                    class="text-slate-400 hover:text-blue-500 transition text-sm flex items-center"><i
                        class="fa-solid fa-shuffle mr-1"></i> Shuffle</button>
            </div>
            <div class="flex items-center gap-4">
                <div id="timer-display"
                    class="hidden text-slate-600 font-mono font-bold bg-white px-3 py-1 rounded-lg border border-slate-200">
                    <i class="fa-regular fa-clock mr-2"></i><span id="time-val">00:00</span>
                </div>
                <div class="flex items-center bg-white rounded-full p-1 border border-slate-200 shadow-sm">
                    <button onclick="setAppMode('learn')" id="tab-learn"
                        class="px-4 py-1.5 rounded-full text-xs font-bold bg-slate-800 text-white transition-all shadow-md">Learn</button>
                    <button onclick="setAppMode('test')" id="tab-test"
                        class="px-4 py-1.5 rounded-full text-xs font-bold text-slate-500 hover:text-slate-800 transition-all">Quiz
                        Mode</button>
                </div>
            </div>
            <div class="text-slate-500 font-mono text-sm"><span id="current-count">1</span> / <span
                    id="total-count">0</span></div>
        </div>

        <div class="w-full h-2 bg-slate-200 rounded-full mb-4 overflow-hidden">
            <div id="progress-bar" class="progress-fill h-full bg-blue-500 w-0 rounded-full"></div>
        </div>

        <div id="mode-controls" class="flex flex-wrap gap-2 justify-center mb-4">
            <button onclick="setMode('chinese')" id="btn-mode-chinese"
                class="mode-btn active px-3 py-1.5 rounded-lg border border-slate-300 text-xs font-semibold text-slate-600 transition">Chinese Focus</button>
            <button onclick="setMode('pinyin')" id="btn-mode-pinyin"
                class="mode-btn px-3 py-1.5 rounded-lg border border-slate-300 text-xs font-semibold text-slate-600 transition">Pinyin Focus</button>
            <button onclick="setMode('meaning')" id="btn-mode-meaning"
                class="mode-btn px-3 py-1.5 rounded-lg border border-slate-300 text-xs font-semibold text-slate-600 transition">Meaning Focus</button>
        </div>

        <!-- FLASHCARD VIEW -->
        <div id="view-flashcard" class="flex-grow flex flex-col relative">
            <div class="flex-grow perspective-container w-full relative mb-6">
                <div id="card-container" class="card-container cursor-pointer w-full h-full select-none" onclick="flipCard()">
                    <div class="card-inner">
                        <!-- Front Face -->
                        <div class="card-face card-front">
                            <div id="card-front-content" class="text-center w-full"></div>
                            <p class="absolute bottom-6 text-slate-300 text-xs uppercase font-bold">Tap to Flip</p>
                        </div>
                        <!-- Back Face -->
                        <div class="card-face card-back">
                            <div id="card-back-content" class="w-full max-w-md space-y-4 text-center"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TEST VIEW -->
        <div id="view-test" class="hidden flex-grow flex flex-col mb-4">
            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-8 mb-4 flex items-center justify-center min-h-[160px]">
                <div id="test-question" class="text-center w-full"></div>
            </div>
            <div id="test-options" class="grid grid-cols-1 md:grid-cols-2 gap-3 flex-grow content-start"></div>
            <div id="test-feedback" class="h-8 text-center text-sm font-bold mt-2 text-slate-400 uppercase tracking-widest">Select an answer</div>
        </div>

        <!-- RESULT VIEW -->
        <div id="view-result" class="hidden flex-grow flex flex-col items-center justify-center bg-white rounded-2xl shadow-xl border border-slate-200 p-8 mb-4 text-center">
            <div class="mb-6"><i class="fa-solid fa-trophy text-6xl text-yellow-400 mb-4 animate-bounce"></i>
                <h2 class="text-3xl font-bold text-slate-800">Quiz Complete!</h2>
            </div>
            <div class="grid grid-cols-3 gap-4 w-full mb-8 text-center">
                <div class="bg-blue-50 p-3 rounded-xl">
                    <p class="text-[10px] uppercase font-bold text-blue-400">Time</p>
                    <p id="res-time" class="text-xl font-bold text-blue-800">00:00</p>
                </div>
                <div class="bg-green-50 p-3 rounded-xl">
                    <p class="text-[10px] uppercase font-bold text-green-500">Accuracy</p>
                    <p id="res-accuracy" class="text-xl font-bold text-green-800">0/0</p>
                </div>
                <div class="bg-red-50 p-3 rounded-xl">
                    <p class="text-[10px] uppercase font-bold text-red-400">Mistakes</p>
                    <p id="res-mistakes" class="text-xl font-bold text-red-800">0</p>
                </div>
            </div>
            <button onclick="restartQuiz()"
                class="px-8 py-3 rounded-full bg-slate-800 text-white font-semibold shadow-lg hover:bg-slate-700 transition">Try Again</button>
        </div>

        <div id="control-bar" class="flex items-center justify-center gap-6 pb-2 mt-auto">
            <button id="btn-prev" onclick="prevCard()"
                class="w-14 h-14 rounded-full bg-white shadow-lg text-slate-400 hover:text-blue-600 transition flex items-center justify-center border border-slate-100"><i
                    class="fa-solid fa-arrow-left text-xl"></i></button>
            <button id="btn-flip" onclick="flipCard()"
                class="px-8 py-3 rounded-full bg-slate-800 text-white font-semibold shadow-lg hover:bg-slate-700 hover:shadow-xl transition active:scale-95">Flip</button>
            <button id="btn-next" onclick="nextCard()"
                class="w-14 h-14 rounded-full bg-white shadow-lg text-slate-400 hover:text-blue-600 transition flex items-center justify-center border border-slate-100"><i
                    class="fa-solid fa-arrow-right text-xl"></i></button>
        </div>
    </div>

    <script>
        // --- 1. GITHUB CONFIGURATION ---
        const GH_CONFIG = {
            owner: 'fangdongyzu',
            repo: 'flashcardfromexcel',
            branch: 'main'
        };

        // --- GLOBAL VARIABLES ---
        let rawCards = [];
        let currentIndex = 0;
        let isFlipped = false;
        let currentMode = 'chinese';
        let appMode = 'learn';
        let timerInterval, timeElapsed = 0;
        let correctFirstTryCount = 0, wrongClicks = 0, isFirstAttempt = true;
        let currentGitHubFiles = [];
        let currentFileId = null;
        
        // New Variables for Column Selection
        let availableMeaningHeaders = []; // Array of objects {index: int, label: string}
        let selectedMeaningIndices = []; // Array of selected column indices

        // --- DOM REFERENCES ---
        const setupScreen = document.getElementById('setup-screen');
        const columnSelectionScreen = document.getElementById('column-selection-screen');
        const appScreen = document.getElementById('app-screen');

        const panelGithub = document.getElementById('panel-github');
        const panelUpload = document.getElementById('panel-upload');
        const tabGithub = document.getElementById('tab-github');
        const tabUpload = document.getElementById('tab-upload');
        const repoStatus = document.getElementById('repo-status');

        const ghFolderSelect = document.getElementById('gh-folder-select');
        const ghFileSelect = document.getElementById('gh-file-select');
        const btnGhLoad = document.getElementById('btn-gh-load');
        const fileInput = document.getElementById('file-input');
        const columnList = document.getElementById('column-list');

        // App DOMs
        const currentCountEl = document.getElementById('current-count');
        const totalCountEl = document.getElementById('total-count');
        const progressBar = document.getElementById('progress-bar');
        const btnChinese = document.getElementById('btn-mode-chinese');
        const btnPinyin = document.getElementById('btn-mode-pinyin');
        const btnMeaning = document.getElementById('btn-mode-meaning');
        const tabLearn = document.getElementById('tab-learn');
        const tabTest = document.getElementById('tab-test');
        const btnPrev = document.getElementById('btn-prev');
        const btnFlip = document.getElementById('btn-flip');
        const controlBar = document.getElementById('control-bar');
        const viewFlashcard = document.getElementById('view-flashcard');
        const viewTest = document.getElementById('view-test');
        const viewResult = document.getElementById('view-result');
        const timerDisplay = document.getElementById('timer-display');
        const timeVal = document.getElementById('time-val');
        const cardContainer = document.getElementById('card-container');
        const frontContent = document.getElementById('card-front-content');
        const backContent = document.getElementById('card-back-content');
        const testQuestion = document.getElementById('test-question');
        const testOptions = document.getElementById('test-options');
        const testFeedback = document.getElementById('test-feedback');
        const resTime = document.getElementById('res-time');
        const resAccuracy = document.getElementById('res-accuracy');
        const resMistakes = document.getElementById('res-mistakes');

        // --- INITIALIZATION ---
        initGitHub();

        // --- EVENT LISTENERS ---
        fileInput.addEventListener('change', handleUpload);
        ghFolderSelect.addEventListener('change', handleGhFolderChange);
        ghFileSelect.addEventListener('change', () => btnGhLoad.disabled = false);

        // --- Double-Click Logic ---
        let clickTimer = null;
        const clickDelay = 300; 

        document.addEventListener('keydown', (e) => {
            if (!setupScreen.classList.contains('hidden')) return;

            // Instant Actions
            if (appMode === 'learn') {
                if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'ArrowDown') {
                    e.preventDefault();
                    flipCard();
                    return;
                }
            }

            // Navigation Keys
            const navKeys = ['ArrowRight', 'ArrowLeft', 'PageDown', 'PageUp'];
            if (navKeys.includes(e.code)) {
                if (e.code.includes('Page')) e.preventDefault(); 

                if (clickTimer) {
                    clearTimeout(clickTimer);
                    clickTimer = null;
                    if (appMode === 'learn') flipCard();
                } else {
                    clickTimer = setTimeout(() => {
                        if (e.code === 'ArrowRight' || e.code === 'PageDown') nextCard();
                        else if (e.code === 'ArrowLeft' || e.code === 'PageUp') {
                            if (appMode === 'learn') prevCard();
                        }
                        clickTimer = null;
                    }, clickDelay);
                }
            }
        });

        // --- SWIPE / TOUCH LOGIC ---
        let touchStartX = 0;
        let touchEndX = 0;
        const minSwipeDistance = 50;

        appScreen.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
        appScreen.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        function handleSwipe() {
            if (appMode !== 'learn') return;
            const distance = touchEndX - touchStartX;
            if (Math.abs(distance) < minSwipeDistance) return;
            if (distance < 0) nextCard();
            else prevCard();
        }

        // --- PROGRESS SAVING ---
        function saveProgress() {
            if (currentFileId && appMode === 'learn') {
                localStorage.setItem(currentFileId, currentIndex);
            }
        }

        // --- SETUP LOGIC ---
        function switchTab(tab) {
            if (tab === 'github') {
                panelGithub.classList.remove('hidden');
                panelUpload.classList.add('hidden');
                tabGithub.classList.add('active');
                tabUpload.classList.remove('active');
            } else {
                panelGithub.classList.add('hidden');
                panelUpload.classList.remove('hidden');
                tabGithub.classList.remove('active');
                tabUpload.classList.add('active');
            }
        }

        // --- GITHUB API INTEGRATION ---
        async function initGitHub() {
            if (GH_CONFIG.owner === 'YOUR_USERNAME') {
                repoStatus.textContent = "Please configure your username in the code.";
                repoStatus.classList.add('text-red-500');
                return;
            }

            try {
                const url = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("Repo not found");

                const data = await response.json();
                const folders = data.filter(item => item.type === 'dir' && item.name !== '.history');

                if (folders.length === 0) {
                    ghFolderSelect.innerHTML = '<option disabled>No folders found</option>';
                    return;
                }

                ghFolderSelect.innerHTML = '<option value="" disabled selected>Choose Folder...</option>';
                folders.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f.path;
                    opt.textContent = f.name.toUpperCase();
                    ghFolderSelect.appendChild(opt);
                });

                repoStatus.textContent = "Connected to GitHub";
                repoStatus.className = "text-green-600 text-sm font-bold";

            } catch (err) {
                console.error(err);
                repoStatus.textContent = "Could not connect to GitHub. Check config.";
                repoStatus.classList.add('text-red-500');
            }
        }

        async function handleGhFolderChange() {
            const folderPath = ghFolderSelect.value;
            ghFileSelect.innerHTML = '<option>Loading...</option>';
            ghFileSelect.disabled = true;
            btnGhLoad.disabled = true;

            try {
                const url = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${folderPath}`;
                const response = await fetch(url);
                const data = await response.json();

                currentGitHubFiles = data.filter(item =>
                    item.name.endsWith('.xlsx') ||
                    item.name.endsWith('.xls') ||
                    item.name.endsWith('.csv')
                );

                currentGitHubFiles.sort((a, b) => b.name.localeCompare(a.name, undefined, { numeric: true, sensitivity: 'base' }));

                ghFileSelect.innerHTML = '<option value="" disabled selected>Select File...</option>';
                currentGitHubFiles.forEach((f, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.textContent = f.name;
                    ghFileSelect.appendChild(opt);
                });

                ghFileSelect.disabled = false;

            } catch (err) {
                alert("Error fetching file list: " + err.message);
            }
        }

        async function loadGitHubFile() {
            const fileIndex = ghFileSelect.value;
            const fileObj = currentGitHubFiles[fileIndex];

            if (!fileObj) return;
            currentFileId = `gh_progress_${fileObj.path}`;

            btnGhLoad.textContent = "Downloading...";
            btnGhLoad.disabled = true;

            try {
                const response = await fetch(fileObj.download_url);
                if (!response.ok) throw new Error("Download failed");

                if (fileObj.name.toLowerCase().endsWith('.csv')) {
                    const text = await response.text();
                    const fixedText = text.replaceAll('，', ',');
                    const workbook = XLSX.read(fixedText, { type: 'string' });
                    parseWorkbook(workbook);
                } else {
                    const arrayBuffer = await response.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array', codepage: 65001 });
                    parseWorkbook(workbook);
                }
            } catch (err) {
                alert("Error downloading file: " + err.message);
                btnGhLoad.textContent = "Load Deck";
                btnGhLoad.disabled = false;
            }
        }

        // --- LOCAL FILE UPLOAD ---
        function handleUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            currentFileId = `local_progress_${file.name}`;

            const reader = new FileReader();
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.onload = function(e) {
                    const text = e.target.result;
                    const fixedText = text.replaceAll('，', ',');
                    const workbook = XLSX.read(fixedText, { type: 'string' });
                    parseWorkbook(workbook);
                }
                reader.readAsText(file); 
            } else {
                reader.onload = function (e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', codepage: 65001 });
                    parseWorkbook(workbook);
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // --- CORE PARSER ---
        function parseWorkbook(workbook) {
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            if (rows.length < 2) { alert("File is empty or invalid."); btnGhLoad.textContent = "Load Deck"; btnGhLoad.disabled = false; return; }
            const headers = rows[0];

            const codeIndex = headers.findIndex(h => h && h.toString().toUpperCase() === 'CODE');

            // 1. Identify Available Columns
            availableMeaningHeaders = [];
            headers.forEach((h, index) => {
                // Skip Chinese (0), Pinyin (1), and Code
                if (index > 1 && index !== codeIndex) {
                    availableMeaningHeaders.push({
                        index: index,
                        label: h || `Column ${index + 1}`
                    });
                }
            });

            // 2. Parse Cards
            rawCards = rows.slice(1).filter(row => row[0]).map(row => {
                const meanings = row.slice(2).map((val, idx) => {
                    const realIdx = idx + 2;
                    if (realIdx === codeIndex) return null;
                    
                    return {
                        label: headers[realIdx] || `Def ${idx + 1}`,
                        value: val || "-",
                        colIndex: realIdx // Crucial for filtering later
                    };
                }).filter(m => m && m.value !== "-");

                return {
                    chinese: { label: "Chinese", value: row[0] },
                    pinyin: { label: "Pinyin", value: row[1] || "-" },
                    meanings: meanings,
                    // Note: meaningString will be dynamically generated based on selection now
                    code: codeIndex > -1 ? row[codeIndex] : null
                };
            });

            if (rawCards.length === 0) { alert("No valid cards found."); return; }

            // 3. Show Column Selection Screen instead of going straight to app
            showColumnSelection();
        }

        function showColumnSelection() {
            setupScreen.classList.add('hidden');
            columnSelectionScreen.classList.remove('hidden');
            columnList.innerHTML = '';
            selectedMeaningIndices = []; // Reset

            if (availableMeaningHeaders.length === 0) {
                columnList.innerHTML = '<p class="text-slate-400">No extra columns found to select.</p>';
                return;
            }

            availableMeaningHeaders.forEach(col => {
                const div = document.createElement('div');
                div.className = "flex items-center p-3 border border-slate-100 rounded-lg mb-2 hover:bg-slate-50";
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = col.index;
                checkbox.id = `col-${col.index}`;
                // Default UNCHOSEN
                checkbox.checked = false; 
                checkbox.className = "w-5 h-5 text-blue-600 rounded border-slate-300 focus:ring-blue-500 custom-checkbox";

                const label = document.createElement('label');
                label.htmlFor = `col-${col.index}`;
                label.className = "ml-3 text-slate-700 font-medium cursor-pointer w-full";
                label.textContent = col.label;

                div.appendChild(checkbox);
                div.appendChild(label);
                columnList.appendChild(div);
            });
        }

        function confirmColumnSelection() {
            // Gather selected indices
            const checkboxes = columnList.querySelectorAll('input[type="checkbox"]:checked');
            selectedMeaningIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            // Proceed to App
            columnSelectionScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            
            // Resume Logic (Keep here to run after selection)
            const savedIndex = localStorage.getItem(currentFileId);
            currentIndex = 0;
            if (savedIndex !== null) {
                const parsedIndex = parseInt(savedIndex);
                if (!isNaN(parsedIndex) && parsedIndex < rawCards.length && parsedIndex > 0) {
                    const resume = confirm(`You left off at card ${parsedIndex + 1}. Do you want to resume?`);
                    if (resume) currentIndex = parsedIndex;
                    else localStorage.removeItem(currentFileId);
                }
            }

            btnGhLoad.textContent = "Load Deck";
            btnGhLoad.disabled = false;
            
            updateModeButtons();
            
            isFlipped = false;
            currentMode = 'chinese';
            updateModeActiveState();
            setAppMode('learn');
        }

        function resetApp() {
            stopTimer();
            appScreen.classList.add('hidden');
            columnSelectionScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            fileInput.value = '';
            currentFileId = null;
        }

        // --- APP LOGIC ---
        function updateModeButtons() {
            // Check if user selected any meaning columns
            const hasSelectedMeanings = selectedMeaningIndices.length > 0;
            if (!hasSelectedMeanings) {
                btnChinese.textContent = "Chinese -> Pinyin";
                btnPinyin.textContent = "Pinyin -> Chinese";
                btnMeaning.style.display = 'none';
            } else {
                btnMeaning.style.display = 'block';
            }
        }

        function setAppMode(mode) {
            appMode = mode;
            viewResult.classList.add('hidden');
            controlBar.classList.remove('hidden');

            if (mode === 'learn') {
                tabLearn.classList.replace('text-slate-500', 'bg-slate-800');
                tabLearn.classList.replace('hover:text-slate-800', 'text-white');
                tabLearn.classList.add('shadow-md');
                tabTest.className = "px-4 py-1.5 rounded-full text-xs font-bold text-slate-500 hover:text-slate-800 transition-all";

                viewFlashcard.classList.remove('hidden');
                viewTest.classList.add('hidden');
                timerDisplay.classList.add('hidden');
                btnFlip.style.display = 'block';
                btnPrev.style.visibility = 'visible';
                stopTimer(); renderCard();
            } else {
                tabTest.className = "px-4 py-1.5 rounded-full text-xs font-bold bg-blue-600 text-white transition-all shadow-md";
                tabLearn.className = "px-4 py-1.5 rounded-full text-xs font-bold text-slate-500 hover:text-slate-800 transition-all";

                viewFlashcard.classList.add('hidden');
                viewTest.classList.remove('hidden');
                timerDisplay.classList.remove('hidden');
                btnFlip.style.display = 'none';
                btnPrev.style.visibility = 'hidden';
                restartQuiz();
            }
        }

        function setMode(mode) {
            if (currentMode === mode) return;
            currentMode = mode;
            updateModeActiveState();
            if (appMode === 'learn') renderCard();
            else restartQuiz();
        }

        function updateModeActiveState() {
            [btnChinese, btnPinyin, btnMeaning].forEach(btn => btn.classList.remove('active'));
            if (currentMode === 'chinese') btnChinese.classList.add('active');
            if (currentMode === 'pinyin') btnPinyin.classList.add('active');
            if (currentMode === 'meaning') btnMeaning.classList.add('active');
        }

        // --- SHUFFLE LOGIC ---
        function randomizeData() {
            for (let i = rawCards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [rawCards[i], rawCards[j]] = [rawCards[j], rawCards[i]];
            }
        }

        function shuffleCards() {
            randomizeData();
            
            // Animation
            const target = appMode === 'learn' ? cardContainer.parentElement : testQuestion.parentElement;
            target.classList.add('shaking');
            setTimeout(() => target.classList.remove('shaking'), 400);

            if (appMode === 'learn') {
                 currentIndex = 0; 
                 renderCard(); 
            } else {
                 restartQuiz();
            }
        }

        function updateProgress() {
            currentCountEl.textContent = currentIndex + 1;
            totalCountEl.textContent = rawCards.length;
            progressBar.style.width = `${((currentIndex + 1) / rawCards.length) * 100}%`;
        }

        // --- HELPER: GET SELECTED MEANINGS ---
        function getSelectedMeanings(card) {
            return card.meanings.filter(m => selectedMeaningIndices.includes(m.colIndex));
        }

        function getSelectedMeaningString(card) {
            const selected = getSelectedMeanings(card);
            if (selected.length === 0) return "";
            return selected.map(m => m.value).join(", ");
        }

        // --- FLASHCARD RENDER ---
        function renderCard() {
            const card = rawCards[currentIndex];

            if (!isFlipped) {
                const inner = cardContainer.querySelector('.card-inner');
                inner.style.transition = 'none';
                cardContainer.classList.remove('flipped');
                void cardContainer.offsetWidth;
                inner.style.transition = '';
            }

            let front = '', backItems = [];
            const selectedMeanings = getSelectedMeanings(card);

            if (currentMode === 'chinese') {
                front = `<h2 class="text-6xl md:text-7xl font-bold text-slate-800">${card.chinese.value}</h2>`;
                backItems = [card.pinyin, ...selectedMeanings];
            } else if (currentMode === 'pinyin') {
                front = `<h2 class="text-5xl md:text-6xl font-bold text-slate-800">${card.pinyin.value}</h2>`;
                backItems = [card.chinese, ...selectedMeanings];
            } else {
                // Meaning Mode
                if (selectedMeanings.length === 0) {
                    front = `<div class="text-slate-400 italic">No columns selected</div>`;
                } else {
                    front = `<div class="flex flex-col gap-4 w-full">` +
                        selectedMeanings.map(m =>
                            `<div class="p-3 bg-slate-50 rounded-xl border border-slate-200 w-full">
                                <span class="text-xs font-bold text-slate-400 uppercase block mb-1">${m.label}</span>
                                <span class="text-lg font-bold text-slate-700">${m.value}</span>
                            </div>`
                        ).join('') + `</div>`;
                }
                backItems = [card.chinese, card.pinyin];
            }

            if (card.code) {
                front += `<div class="absolute bottom-4 right-6 text-xl font-mono text-slate-300 font-bold select-none tracking-widest">${card.code}</div>`;
            }

            frontContent.innerHTML = front;
            
            backContent.innerHTML = backItems.map(item =>
                `<div class="bg-slate-50 rounded-xl p-4 w-full border border-slate-100">
                    <p class="text-sm font-bold text-slate-400 uppercase mb-2">${item.label}</p>
                    <p class="text-5xl font-bold text-slate-800">${item.value}</p>
                </div>`
            ).join('');

            updateProgress();
            saveProgress();
        }

        // --- QUIZ MODE RENDER ---
        function renderTest() {
            testFeedback.textContent = "Select an answer";
            testFeedback.className = "h-8 text-center text-sm font-bold mt-2 text-slate-400 uppercase tracking-widest";
            testOptions.innerHTML = '';
            isFirstAttempt = true;

            const card = rawCards[currentIndex];
            let questionHtml = '';
            let answerKey = ''; // 'chinese' or 'selectedMeaning'

            const selectedMeaningString = getSelectedMeaningString(card);
            const displayMeaning = selectedMeaningString || "(No columns selected)";

            // Setup Question & Answer Key
            if (currentMode === 'chinese') {
                // Focus: Check what is in flashcard (Chinese -> Meaning)
                // Q: Chinese, A: Selected Columns
                questionHtml = `<div class="text-xs text-slate-400 uppercase mb-2">Select the correct definition</div><h2 class="text-6xl font-bold text-slate-800">${card.chinese.value}</h2>`;
                answerKey = 'selectedMeaning';
            } else if (currentMode === 'pinyin') {
                // Focus: Pinyin (original logic)
                // Q: Pinyin, A: Chinese
                questionHtml = `<div class="text-xs text-slate-400 uppercase mb-2">Character?</div><h2 class="text-5xl font-bold text-slate-800">${card.pinyin.value}</h2>`;
                answerKey = 'chinese';
            } else { 
                // Focus: Meaning
                // Q: Selected Columns, A: Chinese
                questionHtml = `<div class="text-xs text-slate-400 uppercase mb-2">Character?</div><div class="text-5xl font-bold text-slate-800 px-4 leading-tight">${displayMeaning}</div>`;
                answerKey = 'chinese';
            }

            testQuestion.innerHTML = questionHtml;

            // Generate Options
            const options = [card];
            let safety = 0;
            while (options.length < 4 && options.length < rawCards.length && safety < 100) {
                const randomCard = rawCards[Math.floor(Math.random() * rawCards.length)];
                if (!options.includes(randomCard)) options.push(randomCard);
                safety++;
            }
            
            options.sort(() => Math.random() - 0.5);

            options.forEach(opt => {
                const isCorrect = (opt === card);
                const btn = document.createElement('button');
                btn.className = "option-btn w-full p-6 rounded-xl text-3xl font-bold text-slate-700 bg-white shadow-sm flex flex-col items-center justify-center min-h-[100px]";
                
                let btnText = '';
                if (answerKey === 'chinese') {
                    btnText = opt.chinese.value;
                } else {
                    // Answer is meaning
                    const optMeaning = getSelectedMeaningString(opt);
                    btnText = optMeaning || "(No data)";
                }

                btn.textContent = btnText;
                btn.dataset.correct = isCorrect;
                btn.onclick = () => checkAnswer(btn);
                
                testOptions.appendChild(btn);
            });
            updateProgress();
        }

        function checkAnswer(btn) {
            if (btn.disabled) return;
            
            const isCorrect = btn.dataset.correct === 'true';
            const allBtns = Array.from(testOptions.children);
            
            allBtns.forEach(b => b.disabled = true);

            if (isCorrect) {
                btn.classList.add('correct');
                testFeedback.textContent = "Correct!";
                testFeedback.className = "h-8 text-center text-sm font-bold mt-2 text-green-500 uppercase tracking-widest animate-pulse";
                
                if (isFirstAttempt) correctFirstTryCount++;

                setTimeout(() => {
                    if (currentIndex < rawCards.length - 1) {
                        currentIndex++;
                        isFirstAttempt = true;
                        renderTest();
                    } else {
                        endQuiz();
                    }
                }, 1000);
            } else {
                btn.classList.add('incorrect');
                wrongClicks++;
                isFirstAttempt = false;
                
                testFeedback.textContent = "Try Again";
                testFeedback.className = "h-8 text-center text-sm font-bold mt-2 text-red-500 uppercase tracking-widest";

                const correctBtn = allBtns.find(b => b.dataset.correct === 'true');
                if (correctBtn) correctBtn.classList.add('correct');

                setTimeout(() => {
                    allBtns.forEach(b => {
                        if (!b.classList.contains('incorrect') && !b.classList.contains('correct')) {
                            b.disabled = false;
                        }
                    });
                }, 1000);
            }
        }

        function nextCard() { if (currentIndex < rawCards.length - 1) { currentIndex++; isFlipped = false; renderCard(); } }
        function prevCard() { if (currentIndex > 0) { currentIndex--; isFlipped = false; renderCard(); } }
        function flipCard() { isFlipped = !isFlipped; if (isFlipped) cardContainer.classList.add('flipped'); else cardContainer.classList.remove('flipped'); }
        
        function startTimer() { 
            timeElapsed = 0; 
            timeVal.textContent = "00:00"; 
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => { 
                timeElapsed++; 
                const m = Math.floor(timeElapsed / 60).toString().padStart(2, '0'); 
                const s = (timeElapsed % 60).toString().padStart(2, '0'); 
                timeVal.textContent = `${m}:${s}`; 
            }, 1000); 
        }
        
        function stopTimer() { clearInterval(timerInterval); }
        
        function restartQuiz() { 
            currentIndex = 0; 
            correctFirstTryCount = 0; 
            wrongClicks = 0; 
            randomizeData();
            startTimer(); 
            renderTest(); 
        }
        
        function endQuiz() {
            stopTimer(); 
            viewTest.classList.add('hidden'); 
            viewResult.classList.remove('hidden'); 
            controlBar.classList.add('hidden');
            const m = Math.floor(timeElapsed / 60).toString().padStart(2, '0'); 
            const s = (timeElapsed % 60).toString().padStart(2, '0');
            resTime.textContent = `${m}:${s}`; 
            resAccuracy.textContent = `${correctFirstTryCount}/${rawCards.length}`; 
            resMistakes.textContent = wrongClicks;
        }
    </script>
</body>

</html>