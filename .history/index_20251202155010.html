<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Flashcards & Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Sans+TC:wght@400;700&display=swap');

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            -webkit-font-smoothing: antialiased;
        }

        /* --- 3D Flip Styles --- */
        .perspective-container { perspective: 1000px; }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
            transform-style: preserve-3d;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .card-container.flipped .card-inner { transform: rotateX(180deg); }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1.5rem;
            background: white;
            padding: 2rem;
            overflow-y: auto;
        }
        .card-back { transform: rotateX(180deg); background: #ffffff; border: 2px solid #e5e7eb; }
        .card-front { background: #ffffff; border: 2px solid #e5e7eb; }

        /* Scrollbars */
        .card-face::-webkit-scrollbar { width: 8px; }
        .card-face::-webkit-scrollbar-track { background: transparent; }
        .card-face::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }

        /* Input Zone */
        .drop-zone { border: 2px dashed #cbd5e1; transition: all 0.3s ease; }
        .drop-zone:hover, .drop-zone.dragover { border-color: #3b82f6; background-color: #eff6ff; }

        /* Progress & Buttons */
        .progress-fill { transition: width 0.3s ease; }
        .mode-btn.active { background-color: #1e293b; color: white; border-color: #1e293b; }

        /* Shuffle Animation */
        @keyframes shuffleShake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-1deg); }
            50% { transform: translateX(5px) rotate(1deg); }
            75% { transform: translateX(-5px) rotate(-1deg); }
            100% { transform: translateX(0); }
        }
        .shaking { animation: shuffleShake 0.4s ease-in-out; }

        /* --- TEST MODE STYLES --- */
        .option-btn {
            transition: all 0.2s ease;
            border: 2px solid #e2e8f0;
        }
        .option-btn:hover:not(:disabled) {
            border-color: #94a3b8;
            background-color: #f8fafc;
        }
        .option-btn.correct {
            background-color: #dcfce7; /* Green 100 */
            border-color: #22c55e; /* Green 500 */
            color: #166534;
        }
        .option-btn.incorrect {
            background-color: #fee2e2; /* Red 100 */
            border-color: #ef4444; /* Red 500 */
            color: #991b1b;
            opacity: 0.7;
        }
        
        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col items-center justify-center text-slate-800 p-4">

    <div id="setup-screen" class="w-full max-w-lg bg-white p-8 rounded-3xl shadow-xl text-center">
        <div class="mb-6">
            <i class="fa-solid fa-layer-group text-5xl text-blue-500 mb-4"></i>
            <h1 class="text-3xl font-bold mb-2">Flashcard Import</h1>
            <p class="text-slate-500">Upload your Excel (.xlsx) file to begin.</p>
        </div>
        
        <label class="drop-zone w-full h-40 flex flex-col items-center justify-center rounded-2xl cursor-pointer mb-6">
            <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i>
            <span class="text-slate-500 font-medium">Click to upload or drag file here</span>
            <input type="file" id="file-input" accept=".xlsx, .xls, .csv" class="hidden" />
        </label>

        <div class="text-xs text-left text-slate-400 bg-slate-50 p-4 rounded-xl">
            <p class="font-bold mb-1">Format Requirement:</p>
            <ul class="list-disc list-inside">
                <li>Col 1: Chinese</li>
                <li>Col 2: Pinyin</li>
                <li>Col 3+: Meaning(s)</li>
            </ul>
        </div>
    </div>

    <div id="app-screen" class="hidden w-full max-w-2xl flex flex-col h-[95vh] py-2">
        
        <div class="flex flex-col md:flex-row items-center justify-between mb-3 px-2 gap-3">
            <div class="flex gap-4">
                <button onclick="resetApp()" class="text-slate-400 hover:text-red-500 transition text-sm flex items-center">
                    <i class="fa-solid fa-arrow-left mr-1"></i> Exit
                </button>
                <button onclick="shuffleCards()" class="text-slate-400 hover:text-blue-500 transition text-sm flex items-center" title="Shuffle Deck">
                    <i class="fa-solid fa-shuffle mr-1"></i> Shuffle
                </button>
            </div>

            <div class="flex items-center bg-white rounded-full p-1 border border-slate-200 shadow-sm">
                <button onclick="setAppMode('learn')" id="tab-learn" class="px-4 py-1.5 rounded-full text-xs font-bold bg-slate-800 text-white transition-all shadow-md">Learn</button>
                <button onclick="setAppMode('test')" id="tab-test" class="px-4 py-1.5 rounded-full text-xs font-bold text-slate-500 hover:text-slate-800 transition-all">Quiz Mode</button>
            </div>

            <div class="text-slate-500 font-mono text-sm">
                <span id="current-count">1</span> / <span id="total-count">0</span>
            </div>
        </div>

        <div class="w-full h-2 bg-slate-200 rounded-full mb-4 overflow-hidden">
            <div id="progress-bar" class="progress-fill h-full bg-blue-500 w-0 rounded-full"></div>
        </div>

        <div id="mode-controls" class="flex flex-wrap gap-2 justify-center mb-4">
            <button onclick="setMode('chinese')" id="btn-mode-chinese" class="mode-btn active px-3 py-1.5 rounded-lg border border-slate-300 text-xs font-semibold text-slate-600 hover:bg-slate-100 transition">
                Chinese Focus
            </button>
            <button onclick="setMode('pinyin')" id="btn-mode-pinyin" class="mode-btn px-3 py-1.5 rounded-lg border border-slate-300 text-xs font-semibold text-slate-600 hover:bg-slate-100 transition">
                Pinyin Focus
            </button>
            <button onclick="setMode('meaning')" id="btn-mode-meaning" class="mode-btn px-3 py-1.5 rounded-lg border border-slate-300 text-xs font-semibold text-slate-600 hover:bg-slate-100 transition">
                Meaning Focus
            </button>
        </div>

        <div id="view-flashcard" class="flex-grow flex flex-col">
            <div class="flex-grow perspective-container w-full relative mb-6">
                <div id="card-container" class="card-container cursor-pointer w-full h-full" onclick="flipCard()">
                    <div class="card-inner">
                        <div class="card-face card-front">
                            <div id="card-front-content" class="text-center w-full"></div>
                            <p class="absolute bottom-6 text-slate-300 text-xs uppercase tracking-widest font-semibold">Tap to Flip</p>
                        </div>
                        <div class="card-face card-back">
                            <div id="card-back-content" class="w-full max-w-md space-y-4 text-center"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-center gap-6 pb-2">
                <button onclick="prevCard()" class="w-14 h-14 rounded-full bg-white shadow-lg text-slate-400 hover:text-blue-600 hover:scale-110 transition flex items-center justify-center border border-slate-100">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </button>
                <button onclick="flipCard()" class="px-8 py-3 rounded-full bg-slate-800 text-white font-semibold shadow-lg hover:bg-slate-700 hover:shadow-xl transition active:scale-95">
                    Flip
                </button>
                <button onclick="nextCard()" class="w-14 h-14 rounded-full bg-white shadow-lg text-slate-400 hover:text-blue-600 hover:scale-110 transition flex items-center justify-center border border-slate-100">
                    <i class="fa-solid fa-arrow-right text-xl"></i>
                </button>
            </div>
        </div>

        <div id="view-test" class="hidden flex-grow flex flex-col">
            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-8 mb-4 flex items-center justify-center min-h-[160px]">
                <div id="test-question" class="text-center">
                    </div>
            </div>

            <div id="test-options" class="grid grid-cols-1 md:grid-cols-2 gap-3 flex-grow content-start">
                </div>

            <div id="test-feedback" class="h-8 text-center text-sm font-bold mt-2 text-slate-400 uppercase tracking-widest">
                Select an answer
            </div>
        </div>
        
    </div>

    <script>
        // --- DATA STATE ---
        let rawCards = []; 
        let currentIndex = 0;
        let isFlipped = false;
        
        // --- APP STATE ---
        let currentMode = 'chinese'; // 'chinese', 'pinyin', 'meaning'
        let appMode = 'learn'; // 'learn' or 'test'
        let hasMeanings = false;
        let isAnswering = false; // Lock for quiz input

        // --- DOM ELEMENTS ---
        const setupScreen = document.getElementById('setup-screen');
        const appScreen = document.getElementById('app-screen');
        const fileInput = document.getElementById('file-input');
        
        // Navigation & Progress
        const currentCountEl = document.getElementById('current-count');
        const totalCountEl = document.getElementById('total-count');
        const progressBar = document.getElementById('progress-bar');
        
        // Buttons
        const btnChinese = document.getElementById('btn-mode-chinese');
        const btnPinyin = document.getElementById('btn-mode-pinyin');
        const btnMeaning = document.getElementById('btn-mode-meaning');
        const tabLearn = document.getElementById('tab-learn');
        const tabTest = document.getElementById('tab-test');

        // Views
        const viewFlashcard = document.getElementById('view-flashcard');
        const viewTest = document.getElementById('view-test');
        
        // Flashcard Elements
        const cardContainer = document.getElementById('card-container');
        const frontContent = document.getElementById('card-front-content');
        const backContent = document.getElementById('card-back-content');

        // Test Elements
        const testQuestion = document.getElementById('test-question');
        const testOptions = document.getElementById('test-options');
        const testFeedback = document.getElementById('test-feedback');

        // --- EVENT LISTENERS ---
        fileInput.addEventListener('change', handleFile);
        
        document.addEventListener('keydown', (e) => {
            if (setupScreen.classList.contains('hidden')) {
                if(appMode === 'learn') {
                    if (e.code === 'Space') { e.preventDefault(); flipCard(); }
                    else if (e.code === 'ArrowRight') nextCard();
                    else if (e.code === 'ArrowLeft') prevCard();
                    else if (e.code === 'ArrowUp' || e.code === 'ArrowDown') flipCard();
                }
            }
        });

        // --- 1. FILE PROCESSING ---
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                processData(rawData);
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(rows) {
            if (rows.length < 2) { alert("File is empty."); return; }
            const headers = rows[0]; 
            
            rawCards = rows.slice(1).filter(row => row[0]).map(row => {
                const meanings = row.slice(2).map((val, idx) => ({
                    label: headers[idx + 2] || `Def ${idx + 1}`,
                    value: val || "-"
                })).filter(m => m.value !== "-");

                // Create a single string for meanings for quiz buttons
                const meaningString = meanings.map(m => m.value).join(", ");

                return {
                    chinese: { label: "Chinese", value: row[0] },
                    pinyin: { label: "Pinyin", value: row[1] || "-" },
                    meanings: meanings,
                    meaningString: meaningString
                };
            });

            if (rawCards.length === 0) { alert("No valid cards found."); return; }
            hasMeanings = rawCards[0].meanings.length > 0;
            
            // Init UI
            updateModeButtons();
            currentIndex = 0;
            isFlipped = false;
            currentMode = 'chinese';
            appMode = 'learn';
            
            updateModeActiveState();
            setAppMode('learn'); // triggers render
            setupScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
        }

        function updateModeButtons() {
            if (!hasMeanings) {
                btnChinese.textContent = "Chinese -> Pinyin";
                btnPinyin.textContent = "Pinyin -> Chinese";
                btnMeaning.style.display = 'none'; 
            }
        }

        // --- 2. GLOBAL CONTROLS ---
        function setAppMode(mode) {
            appMode = mode;
            
            // Toggle Tab Styles
            if (mode === 'learn') {
                tabLearn.className = "px-4 py-1.5 rounded-full text-xs font-bold bg-slate-800 text-white transition-all shadow-md";
                tabTest.className = "px-4 py-1.5 rounded-full text-xs font-bold text-slate-500 hover:text-slate-800 transition-all";
                viewFlashcard.classList.remove('hidden');
                viewTest.classList.add('hidden');
                renderCard();
            } else {
                tabTest.className = "px-4 py-1.5 rounded-full text-xs font-bold bg-blue-600 text-white transition-all shadow-md";
                tabLearn.className = "px-4 py-1.5 rounded-full text-xs font-bold text-slate-500 hover:text-slate-800 transition-all";
                viewFlashcard.classList.add('hidden');
                viewTest.classList.remove('hidden');
                renderTest();
            }
        }

        function setMode(mode) {
            if (currentMode === mode) return;
            currentMode = mode;
            updateModeActiveState();
            if (appMode === 'learn') renderCard();
            else renderTest();
        }

        function updateModeActiveState() {
            [btnChinese, btnPinyin, btnMeaning].forEach(btn => btn.classList.remove('active'));
            if (currentMode === 'chinese') btnChinese.classList.add('active');
            if (currentMode === 'pinyin') btnPinyin.classList.add('active');
            if (currentMode === 'meaning') btnMeaning.classList.add('active');
        }

        function shuffleCards() {
            for (let i = rawCards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [rawCards[i], rawCards[j]] = [rawCards[j], rawCards[i]];
            }
            currentIndex = 0;
            
            const animTarget = appMode === 'learn' ? cardContainer.parentElement : testQuestion.parentElement;
            animTarget.classList.add('shaking');
            setTimeout(() => animTarget.classList.remove('shaking'), 400);

            if (appMode === 'learn') {
                isFlipped = false;
                cardContainer.classList.remove('flipped');
                setTimeout(() => renderCard(), 300);
            } else {
                renderTest();
            }
        }

        function updateProgress() {
            currentCountEl.textContent = currentIndex + 1;
            totalCountEl.textContent = rawCards.length;
            const percentage = ((currentIndex + 1) / rawCards.length) * 100;
            progressBar.style.width = `${percentage}%`;
        }

        // --- 3. LEARN MODE LOGIC ---
        function renderCard() {
            const cardData = rawCards[currentIndex];
            if (!isFlipped) cardContainer.classList.remove('flipped');

            let frontHtml = '';
            let backItems = [];

            if (currentMode === 'chinese') {
                frontHtml = `<h2 class="text-6xl md:text-7xl font-bold text-slate-800 leading-tight">${cardData.chinese.value}</h2>`;
                backItems.push(cardData.pinyin);
                if(hasMeanings) backItems = backItems.concat(cardData.meanings);
            } else if (currentMode === 'pinyin') {
                frontHtml = `<h2 class="text-5xl md:text-6xl font-bold text-slate-800 leading-tight">${cardData.pinyin.value}</h2>`;
                backItems.push(cardData.chinese);
                if(hasMeanings) backItems = backItems.concat(cardData.meanings);
            } else if (currentMode === 'meaning') {
                const meaningsHtml = cardData.meanings.map(m => `
                    <div class="mb-4 last:mb-0">
                        <div class="text-xs text-slate-400 uppercase tracking-widest mb-1">${m.label}</div>
                        <div class="text-3xl font-bold text-slate-800">${m.value}</div>
                    </div>`).join('');
                frontHtml = `<div class="flex flex-col">${meaningsHtml}</div>`;
                backItems.push(cardData.chinese);
                backItems.push(cardData.pinyin);
            }

            frontContent.innerHTML = frontHtml;
            backContent.innerHTML = '';
            backItems.forEach(item => {
                if(!item.value || item.value === '-') return;
                const rowDiv = document.createElement('div');
                rowDiv.className = "flex flex-col border-b border-slate-100 pb-3 last:border-0";
                rowDiv.innerHTML = `
                    <span class="text-xs text-slate-400 uppercase font-semibold tracking-wider mb-1">${item.label}</span>
                    <span class="text-4xl text-slate-800 font-bold">${item.value}</span>
                `;
                backContent.appendChild(rowDiv);
            });

            updateProgress();
        }

        function flipCard() { isFlipped = !isFlipped; cardContainer.classList.toggle('flipped'); }
        function nextCard() { if (currentIndex < rawCards.length - 1) { currentIndex++; if(appMode === 'learn') renderCard(); else renderTest(); } }
        function prevCard() { if (currentIndex > 0) { currentIndex--; if(appMode === 'learn') renderCard(); else renderTest(); } }

        // --- 4. TEST MODE LOGIC (NEW) ---
        function renderTest() {
            isAnswering = false;
            testFeedback.textContent = "Select an answer";
            testFeedback.className = "h-8 text-center text-sm font-bold mt-2 text-slate-400 uppercase tracking-widest";
            
            const currentCard = rawCards[currentIndex];
            let questionHtml = '';
            let correctAnswer = '';
            let answerKey = ''; // Used to generate distractors

            // MODE 1: Chinese -> Test Meaning
            if (currentMode === 'chinese') {
                questionHtml = `<div class="text-xs text-slate-400 uppercase tracking-wider mb-2">What does this mean?</div>
                                <div class="text-6xl font-bold text-slate-800">${currentCard.chinese.value}</div>`;
                correctAnswer = currentCard.meaningString;
                answerKey = 'meaningString'; // Look at meaningString for options
            } 
            // MODE 2: Pinyin -> Test Chinese
            else if (currentMode === 'pinyin') {
                questionHtml = `<div class="text-xs text-slate-400 uppercase tracking-wider mb-2">Select the Chinese Character</div>
                                <div class="text-5xl font-bold text-slate-800">${currentCard.pinyin.value}</div>`;
                correctAnswer = currentCard.chinese.value;
                answerKey = 'chinese';
            }
            // MODE 3: Meaning -> Test Chinese
            else if (currentMode === 'meaning') {
                questionHtml = `<div class="text-xs text-slate-400 uppercase tracking-wider mb-2">Select the Chinese Character</div>
                                <div class="text-3xl font-bold text-slate-800 line-clamp-3">${currentCard.meaningString}</div>`;
                correctAnswer = currentCard.chinese.value;
                answerKey = 'chinese';
            }

            testQuestion.innerHTML = questionHtml;

            // Generate Options
            const options = [currentCard];
            // Get 3 random wrong answers
            while (options.length < 4 && options.length <= rawCards.length) {
                const randomCard = rawCards[Math.floor(Math.random() * rawCards.length)];
                if (!options.includes(randomCard)) options.push(randomCard);
            }

            // Shuffle options
            for (let i = options.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [options[i], options[j]] = [options[j], options[i]];
            }

            testOptions.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full p-4 rounded-xl text-lg font-medium text-slate-700 bg-white shadow-sm flex items-center justify-center min-h-[80px]";
                
                // Determine what text to show on button
                let btnText = "";
                if (answerKey === 'meaningString') btnText = opt.meaningString; // Show meanings on buttons
                else btnText = opt.chinese.value; // Show Chinese on buttons

                btn.textContent = btnText || "-";
                
                // Click Handler
                btn.onclick = () => checkAnswer(btn, opt === currentCard);
                testOptions.appendChild(btn);
            });

            updateProgress();
        }

        function checkAnswer(btnElement, isCorrect) {
            if (isAnswering) return;
            isAnswering = true;

            const allBtns = testOptions.querySelectorAll('button');
            
            if (isCorrect) {
                btnElement.classList.add('correct');
                testFeedback.textContent = "Correct!";
                testFeedback.className = "h-8 text-center text-sm font-bold mt-2 text-green-600 uppercase tracking-widest";
            } else {
                btnElement.classList.add('incorrect');
                testFeedback.textContent = "Incorrect";
                testFeedback.className = "h-8 text-center text-sm font-bold mt-2 text-red-500 uppercase tracking-widest";
                
                // Highlight the correct one
                allBtns.forEach(b => {
                    // Logic to find correct button based on text comparison is tricky with objects
                    // So we rely on the closure variable from render
                    // Re-scan isn't perfect, but visually marking the clicked one red is usually enough feedback
                    // To be perfect, we'd mark the correct one green here too.
                });
            }

            // Auto advance
            setTimeout(() => {
                if (currentIndex < rawCards.length - 1) {
                    currentIndex++;
                    renderTest();
                } else {
                    testFeedback.textContent = "Deck Complete!";
                    testFeedback.classList.add('text-blue-600');
                    cardContainer.parentElement.classList.add('animate-pulse');
                }
            }, 1000);
        }

        function resetApp() {
            setAppMode('learn');
            appScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            fileInput.value = ''; 
            rawCards = [];
        }
    </script>
</body>
</html>